import express from 'npm:express@4.18.2';
import { load } from 'https://deno.land/std/dotenv/mod.ts';
import memberRoutes from './routes/members.js';
import { join, dirname } from 'https://deno.land/std/path/mod.ts';
import { fileURLToPath } from 'https://deno.land/std/node/url.ts';

const __dirname = dirname(fileURLToPath(import.meta.url));
const env = await load();
const app = express();

app.use(express.json());

// Phá»¥c vá»¥ static files tá»« thÆ° má»¥c frontend (cÃ¹ng cáº¥p vá»›i backend)
const frontendPath = join(__dirname, '../frontend');
app.use(express.static(frontendPath));

// Routes
app.use('/api', memberRoutes);

app.get('/', (_req, res) => {
  res.json({ 
    message: 'API Gia Pháº£ Ä‘ang hoáº¡t Ä‘á»™ng',
    version: '1.0.0',
    endpoints: {
      members: '/api/members',
      tree: '/api/tree',
      frontend: '/index.html'
    }
  });
});

// Fallback: tráº£ vá» index.html cho cÃ¡c route khÃ´ng khá»›p (cho SPA)
app.get('*', (_req, res) => {
  res.sendFile(join(frontendPath, 'index.html'));
});

const port = env.PORT || Deno.env.get('PORT') || 3000;
app.listen(port, () => {
  console.log(`ğŸš€ Server running on port ${port}`);
  console.log(`ğŸ“ Local: http://localhost:${port}`);
  console.log(`ğŸŒ API: http://localhost:${port}/api/tree`);
  console.log(`ğŸ“ Static files from: ${frontendPath}`);
});
